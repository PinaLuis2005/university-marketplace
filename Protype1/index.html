<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>University Marketplace</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ucfBlack: '#000000',
            ucfGold: '#ba9b37',
            ucfGray: '#1b1b1b'
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>

<body class="bg-neutral-50 text-neutral-900 font-sans">

<header class="top-bar bg-white/90 backdrop-blur border-b border-neutral-200">
  <div class="flex items-center gap-3">
    <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-ucfGold text-black font-semibold shadow-sm">U</div>
    <div class="logo-title text-lg font-semibold text-neutral-900">University Marketplace</div>
  </div>

  <nav class="nav-bubbles hidden md:flex">
    <a href="messages.html" class="nav-bubble">üí¨ Messages</a>
    <a href="index.html" class="nav-bubble active">üõí Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble">üìã My Listings</a>
    <a href="postitem.html" class="nav-bubble sell-button">‚ûï Sell Item</a>
  </nav>

  <div class="search-container flex-1 md:flex-none">
    <input type="text" id="searchBar" class="search-input" placeholder="Search Marketplace...">
    <button id="searchBtn" class="search-btn">üîç</button>
  </div>

  <div class="top-right hidden sm:flex">
    <a href="notifications.html" class="icon-bubble">üîî Notifications</a>
    <a href="profile.html" class="icon-bubble">üë§ Profile</a>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">

  <!-- Sidebar -->
  <aside class="sidebar w-full lg:w-72 bg-white shadow-sm border border-neutral-200 rounded-2xl p-5 space-y-5 sticky top-28">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-neutral-900">Filters</h3>
      <span class="text-xs text-neutral-500">UCF inspired</span>
    </div>

    <!-- Category Smart Dropdown -->
    <div class="filter-section space-y-2">
      <h4 class="text-sm font-medium text-neutral-700">Category</h4>
      <div class="dropdown-container">
        <input type="text" id="categorySearch" placeholder="Type or select category..." autocomplete="off" class="w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ucfGold focus:border-transparent">
        <ul id="categoryList" class="dropdown-list"></ul>
      </div>
    </div>

    <!-- Price Filter -->
    <div class="filter-section space-y-2">
      <h4 class="text-sm font-medium text-neutral-700">Price Range ($)</h4>
      <div class="price-inputs">
        <input type="number" id="minPrice" placeholder="Min" class="w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ucfGold focus:border-transparent">
        <input type="number" id="maxPrice" placeholder="Max" class="w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ucfGold focus:border-transparent">
      </div>
    </div>

    <!-- Building / Dorm -->
    <div class="filter-section space-y-2">
      <h4 class="text-sm font-medium text-neutral-700">Building / Dorm</h4>
      <select id="buildingFilter" class="w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ucfGold focus:border-transparent">
        <option value="">All</option>
        <option>Current Orlando</option>
        <option>Arden Villas</option>
        <option>The Aves</option>
        <option>The Quads</option>
        <option>The Accolade</option>
        <option>The Village</option>
        <option>The Point</option>
        <option>Nike Hall</option>
        <option>Knights Plaza</option>
        <option>Hercules</option>
        <option>Neptune</option>
        <option>Towers</option>
      </select>
    </div>

    <!-- Rating -->
    <div class="filter-section space-y-2">
      <h4 class="text-sm font-medium text-neutral-700">Seller Rating</h4>
      <select id="ratingFilter" class="w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ucfGold focus:border-transparent">
        <option value="">All</option>
        <option value="4">4‚òÖ & up</option>
        <option value="3">3‚òÖ & up</option>
        <option value="2">2‚òÖ & up</option>
      </select>
    </div>

    <!-- Buttons -->
    <div class="space-y-2">
      <button id="searchFilters" class="w-full rounded-xl bg-ucfGold text-black font-semibold py-2.5 transition hover:bg-ucfGold/90">Search</button>
      <button id="resetFilters" class="w-full rounded-xl bg-ucfGray text-white font-semibold py-2.5 transition hover:bg-ucfGray/90">Reset Filters</button>
    </div>
  </aside>

  <!-- Marketplace Wrapper -->
  <div class="marketplace-wrapper flex-1 space-y-4">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <h2 class="text-2xl font-semibold text-neutral-900">Marketplace</h2>
      <a href="postitem.html" class="inline-flex items-center gap-2 rounded-full bg-ucfGold text-black font-semibold px-4 py-2 shadow-sm hover:bg-ucfGold/90 transition">‚ûï Post item</a>
    </div>

    <div class="rounded-2xl border border-neutral-200 bg-white/90 p-4 shadow-sm">
      <h3 class="text-base font-semibold text-neutral-900">Primeros pasos</h3>
      <p class="mt-1 text-sm text-neutral-600">Publica un art√≠culo o encuentra gangas cerca del campus usando los filtros inteligentes.</p>
      <div class="mt-3 grid gap-3 sm:grid-cols-3">
        <div class="flex items-start gap-2">
          <span class="flex h-8 w-8 items-center justify-center rounded-full bg-ucfGold/15 text-sm font-semibold text-ucfGray">1</span>
          <div>
            <p class="text-sm font-semibold text-neutral-900">Explora con la b√∫squeda</p>
            <p class="text-xs text-neutral-600">Escribe palabras clave y combina filtros de precio, edificio y rating.</p>
          </div>
        </div>
        <div class="flex items-start gap-2">
          <span class="flex h-8 w-8 items-center justify-center rounded-full bg-ucfGold/15 text-sm font-semibold text-ucfGray">2</span>
          <div>
            <p class="text-sm font-semibold text-neutral-900">Revisa los detalles</p>
            <p class="text-xs text-neutral-600">Cada tarjeta muestra precio, ubicaci√≥n y categor√≠a; haz clic para ver m√°s.</p>
          </div>
        </div>
        <div class="flex items-start gap-2">
          <span class="flex h-8 w-8 items-center justify-center rounded-full bg-ucfGold/15 text-sm font-semibold text-ucfGray">3</span>
          <div>
            <p class="text-sm font-semibold text-neutral-900">Publica lo tuyo</p>
            <p class="text-xs text-neutral-600">Usa ‚ÄúPost item‚Äù para listar r√°pido con fotos y datos de tu dorm.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="resultCount" class="text-sm text-neutral-600"></div>
    <div class="items-grid" id="marketplaceGrid"></div>
  </div>
</main>

  

<script>
/* === Smart Category Dropdown === */
const categories = [
  "Electronics","Books & Study","Furniture","Clothing & Accessories",
  "Dorm & Home Essentials","Entertainment & Hobbies","Transportation",
  "Tools & Hardware","Beauty & Personal Care","Sports & Outdoors",
  "Appliances","Campus & Travel","Pets & Plants","Other"
];

const categorySearch = document.getElementById("categorySearch");
const categoryList = document.getElementById("categoryList");
let selectedCategory = "";

function showCategoryList(filtered = categories) {
  categoryList.innerHTML = "";
  filtered.forEach(cat => {
    const li = document.createElement("li");
    li.textContent = cat;
    li.addEventListener("click", () => {
      categorySearch.value = cat;
      selectedCategory = cat;
      categoryList.style.display = "none";
    });
    categoryList.appendChild(li);
  });
  categoryList.style.display = filtered.length ? "block" : "none";
}

categorySearch.addEventListener("input", () => {
  const query = categorySearch.value.toLowerCase();
  const filtered = categories.filter(cat => cat.toLowerCase().includes(query));
  showCategoryList(filtered);
});

categorySearch.addEventListener("focus", () => showCategoryList(categories));
document.addEventListener("click", e => {
  if (!e.target.closest(".dropdown-container")) categoryList.style.display = "none";
});

/* === Smart Search Function === */
function similarMatch(text, query) {
  if (!text || !query) return false;
  text = text.toLowerCase();
  query = query.toLowerCase();
  if (text.includes(query)) return true;
  let diffs = 0;
  for (let i = 0; i < Math.min(text.length, query.length); i++) {
    if (text[i] !== query[i]) diffs++;
    if (diffs > 1) return false;
  }
  return true;
}

/* === Marketplace Filter Logic === */
function loadMarketplace() {
  const grid = document.getElementById("marketplaceGrid");
  const resultCount = document.getElementById("resultCount");
  const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
  const currentUser = JSON.parse(localStorage.getItem("loggedInUser")) || { email: localStorage.getItem("loggedInUserId") };

  const searchQuery = document.getElementById("searchBar").value.trim().toLowerCase();
  const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
  const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;
  const building = document.getElementById("buildingFilter").value;
  const rating = parseInt(document.getElementById("ratingFilter").value) || 0;

  grid.innerHTML = "";

  const filtered = items.filter(item => {
    if (item.sellerEmail === currentUser.email || item.sold) return false;

    const title = item.title?.toLowerCase() || "";
    const desc = item.description?.toLowerCase() || "";
    const cat = item.category?.toLowerCase() || "";

    const matchesSearch = !searchQuery ||
      similarMatch(title, searchQuery) ||
      similarMatch(desc, searchQuery) ||
      similarMatch(cat, searchQuery);

    const matchesCategory = !selectedCategory || cat === selectedCategory.toLowerCase();
    const price = parseFloat(item.price) || 0;
    const matchesPrice = price >= minPrice && price <= maxPrice;
    const matchesBuilding = !building || (item.building && item.building === building);
    const matchesRating = !rating || (item.rating && item.rating >= rating);

    return matchesSearch && matchesCategory && matchesPrice && matchesBuilding && matchesRating;
  });

  resultCount.textContent = `${filtered.length} item${filtered.length !== 1 ? "s" : ""} found`;

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full rounded-2xl border border-dashed border-neutral-300 bg-white/70 p-6 text-center text-sm text-neutral-700">
        <p class="font-semibold text-neutral-900">No encontramos art√≠culos con esos filtros.</p>
        <p class="mt-1">Ajusta la b√∫squeda o <a href="postitem.html" class="font-semibold text-ucfGold hover:underline">publica el tuyo</a> para que otros lo vean.</p>
      </div>
    `;
    return;
  }

  const highlight = (text, query) => {
    if (!query) return text;
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const regex = new RegExp(`(${escaped})`, "ig");
    return text.replace(regex, "<mark>$1</mark>");
  };

  filtered.forEach(item => {
    const card = document.createElement("div");
    card.className = "item-card group relative bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden transition hover:-translate-y-1 hover:shadow-lg cursor-pointer";
    const img = (item.images && item.images[0]) || "https://via.placeholder.com/250x160";
    const highlightedTitle = highlight(item.title, searchQuery);
    card.innerHTML = `
      <div class="relative h-[250px] bg-neutral-100 overflow-hidden">
        <img src="${img}" alt="${item.title}" class="marketplace-image transition duration-200 group-hover:scale-105">
      <div class="relative aspect-[4/3] bg-neutral-100 overflow-hidden">
        <img src="${img}" alt="${item.title}" class="h-full w-full object-cover transition duration-200 group-hover:scale-105">
      </div>
      <div class="item-details p-4 space-y-2">
        <div class="flex items-start justify-between gap-3">
          <strong class="text-base text-neutral-900 leading-snug">${highlightedTitle}</strong>
          <span class="text-ucfGold font-semibold">$${item.price}</span>
        </div>
        <p class="text-sm text-neutral-600">${item.building || item.address || "N/A"}</p>
        <p class="text-xs text-neutral-500">${item.category || ""}</p>
      </div>
    `;
    card.addEventListener("click", () => {
      localStorage.setItem("selectedItemId", item.id);
      window.location.href = "itemdetails.html";
    });
    grid.appendChild(card);
  });
}

/* === Event Listeners === */
document.getElementById("searchBtn").addEventListener("click", loadMarketplace);
document.getElementById("searchBar").addEventListener("keypress", e => {
  if (e.key === "Enter") loadMarketplace();
});
document.getElementById("searchFilters").addEventListener("click", loadMarketplace);
document.getElementById("resetFilters").addEventListener("click", () => {
  document.getElementById("searchBar").value = "";
  document.getElementById("minPrice").value = "";
  document.getElementById("maxPrice").value = "";
  document.getElementById("buildingFilter").value = "";
  document.getElementById("ratingFilter").value = "";
  categorySearch.value = "";
  selectedCategory = "";
  loadMarketplace();
});

loadMarketplace();
</script>

</body>
</html>
