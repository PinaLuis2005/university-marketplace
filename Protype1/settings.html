<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="settings.css" />
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" />
</head>
<body class="bg-neutral-50">

<script>
  if (!localStorage.getItem("loggedInUserId")) {
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "login_signup.html";
  }
</script>

<header class="top-bar">
  <div class="brand-group">
    <div class="brand-logo">U</div>
    <div class="logo-title">University Marketplace</div>
  </div>
  <nav class="nav-bubbles" aria-label="Main navigation">
    <a href="messages.html" class="nav-bubble">ğŸ’¬ Messages</a>
    <a href="index.html" class="nav-bubble">ğŸ›’ Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble">ğŸ“‹ My Listings</a>
    <a href="postitem.html" class="nav-bubble sell-button">â• Sell Item</a>
  </nav>
  <div class="top-actions">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search settings" aria-label="Search settings">
      <button class="search-btn" aria-label="Search">ğŸ”</button>
    </div>
    <div class="top-icons">
      <a href="notifications.html" class="icon-bubble" aria-label="Notifications">ğŸ””</a>
      <a href="profile.html" class="icon-bubble" aria-label="Profile">ğŸ‘¤</a>
    </div>
  </div>
</header>

<main class="page-shell content-stack">
  <header class="section-header">
    <div>
      <h1 class="section-title">âš™ï¸ Settings</h1>
      <p class="muted">Manage your account, security, and profile visuals.</p>
    </div>
  </header>

  <section class="section-card">
    <div class="section-header">
      <h2 class="section-title">Account Information</h2>
      <span class="pill">Secure</span>
    </div>
    <div class="form-grid">
      <div class="form-field">
        <label>Current Email / Phone</label>
        <input type="text" id="currentEmailPhone" readonly />
      </div>
      <div class="form-field">
        <label>New Email / Phone</label>
        <input type="text" id="newEmailPhone" />
      </div>
    </div>
    <div class="form-grid">
      <div class="form-field password-wrapper">
        <label>Re-enter Current Password</label>
        <div class="password-control">
          <input type="password" id="currentPasswordCheck" placeholder="Enter your current password" />
          <button type="button" class="toggle-btn" onclick="togglePassword('currentPasswordCheck')">ğŸ‘ Show</button>
        </div>
      </div>
      <div class="form-field password-wrapper">
        <label>New Password</label>
        <div class="password-control">
          <input type="password" id="newPassword" oninput="checkPasswordStrength(this.value)" />
          <button type="button" class="toggle-btn" onclick="togglePassword('newPassword')">ğŸ‘ Show</button>
          <span id="passwordStrength" class="strength-label"></span>
        </div>
      </div>
    </div>
  </section>

  <section class="section-card">
    <div class="section-header">
      <h2 class="section-title">Profile</h2>
      <span class="muted">Pictures and bio</span>
    </div>
    <div class="form-grid">
      <div class="form-field">
        <label>Update Profile Picture</label>
        <input type="file" id="profilePic" accept="image/*" />
        <div class="profile-preview">
          <img id="profilePreviewImg" alt="Profile Preview" />
        </div>
      </div>
      <div class="form-field">
        <label>Change Cover Photo</label>
        <input type="file" id="coverPhoto" accept="image/*" />
        <div class="cover-preview">
          <img id="coverPreviewImg" alt="Cover Preview" />
        </div>
      </div>
    </div>
    <div class="form-field">
      <label>Bio</label>
      <textarea id="bio" rows="3" placeholder="Write something about yourself..."></textarea>
    </div>
  </section>

  <section class="section-card">
    <div class="section-header">
      <h2 class="section-title">Actions</h2>
      <span class="muted">Manage saved items or account</span>
    </div>
    <div class="button-row">
      <button class="btn-primary" onclick="saveSettings()">ğŸ’¾ Save Changes</button>
      <button class="btn-secondary" onclick="clearSaved()">ğŸ§¹ Clear Saved Items</button>
      <button class="btn-secondary danger" onclick="deleteAccount()">âŒ Delete Account</button>
    </div>
  </section>

  <section class="section-card danger-card">
    <div class="section-header">
      <div>
        <h2 class="section-title">Logout</h2>
        <p class="muted">Sign out of University Marketplace</p>
      </div>
      <button class="btn-secondary danger" onclick="logoutUser()">ğŸšª Logout</button>
    </div>
  </section>
</main>

<dialog id="cropDialog" class="crop-dialog">
  <form method="dialog" class="crop-card" onsubmit="return false;">
    <header class="crop-card__header">
      <h3 id="cropTitle">Crop Image</h3>
    </header>
    <div class="crop-card__body">
      <img id="cropperImage" alt="Crop source" />
    </div>
    <menu class="crop-card__actions">
      <button type="button" class="btn" id="btnCancelCrop">âœ– Cancel</button>
      <button type="button" class="btn btn-primary" id="btnSaveCrop">âœ… Save</button>
    </menu>
  </form>
</dialog>

<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script>
  function getUsers() {
    return JSON.parse(localStorage.getItem("users")) || [];
  }
  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }
  function getCurrentUser() {
    const stored = JSON.parse(localStorage.getItem("loggedInUser"));
    if (stored && stored.email) return stored;
    const id = localStorage.getItem("loggedInUserId");
    const users = getUsers();
    return users.find(u => u.email === id) || null;
  }
  function updateUserEverywhere(user) {
    const users = getUsers();
    const idx = users.findIndex(u => u.email === user.email);
    if (idx !== -1) users[idx] = user;
    saveUsers(users);
    localStorage.setItem("loggedInUser", JSON.stringify(user));
    localStorage.setItem("loggedInUserId", user.email);
  }

  function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  }

  function checkPasswordStrength(value) {
    const label = document.getElementById("passwordStrength");
    if (!value) {
      label.textContent = "";
      label.className = "strength-label";
      return;
    }
    let score = 0;
    if (value.length >= 8) score++;
    if (/[A-Z]/.test(value)) score++;
    if (/[0-9]/.test(value)) score++;
    if (/[^A-Za-z0-9]/.test(value)) score++;
    if (score <= 1) {
      label.textContent = "Weak";
      label.className = "strength-label weak";
    } else if (score === 2) {
      label.textContent = "Medium";
      label.className = "strength-label medium";
    } else {
      label.textContent = "Strong";
      label.className = "strength-label strong";
    }
  }

  let cropper = null, cropTarget = null;
  const dlg = document.getElementById('cropDialog');
  const imgEl = document.getElementById('cropperImage');
  const titleEl = document.getElementById('cropTitle');

  function openCropper(file, target) {
    cropTarget = target;
    titleEl.textContent = target === 'profile' ? 'Crop Profile Photo' : 'Crop Cover Photo';
    const reader = new FileReader();
    reader.onload = e => {
      imgEl.src = e.target.result;
      dlg.showModal();
      imgEl.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(imgEl, {
          aspectRatio: target === 'profile' ? 1 : 16 / 9,
          viewMode: 1, dragMode: 'move', background: false,
          autoCropArea: 0.9,
          ready() {
            if (target === 'profile') {
              const box = dlg.querySelector('.cropper-crop-box');
              const face = dlg.querySelector('.cropper-face');
              if (box) box.style.borderRadius = '50%';
              if (face) face.style.borderRadius = '50%';
            }
          }
        });
      };
    };
    reader.readAsDataURL(file);
  }
  function closeCropper() { if (cropper) cropper.destroy(); dlg.close(); }
  function saveCrop() {
    if (!cropper) return;
    const size = cropTarget === 'profile' ? 320 : 1200;
    const canvas = cropper.getCroppedCanvas({
      width: size, height: cropTarget === 'profile' ? size : 675,
      imageSmoothingQuality: "high"
    });
    const dataURL = cropTarget === 'profile'
      ? (() => {
          const circleCanvas = document.createElement("canvas");
          circleCanvas.width = size; circleCanvas.height = size;
          const ctx = circleCanvas.getContext("2d");
          ctx.beginPath();
          ctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
          ctx.clip();
          ctx.drawImage(canvas, 0, 0, size, size);
          return circleCanvas.toDataURL("image/png");
        })()
      : canvas.toDataURL("image/jpeg", 0.92);
    if (cropTarget === "profile") {
      document.getElementById("profilePreviewImg").src = dataURL;
      document.getElementById("profilePreviewImg").dataset.cropped = dataURL;
    } else {
      document.getElementById("coverPreviewImg").src = dataURL;
      document.getElementById("coverPreviewImg").dataset.cropped = dataURL;
    }
    closeCropper();
  }
  document.getElementById('profilePic').addEventListener('change', e => {
    const f = e.target.files[0]; if (f) openCropper(f, 'profile');
  });
  document.getElementById('coverPhoto').addEventListener('change', e => {
    const f = e.target.files[0]; if (f) openCropper(f, 'cover');
  });
  document.getElementById('btnSaveCrop').addEventListener('click', saveCrop);
  document.getElementById('btnCancelCrop').addEventListener('click', closeCropper);

  function loadSettings() {
    const user = getCurrentUser();
    if (!user) return;
    document.getElementById("currentEmailPhone").value = user.email || "";
    document.getElementById("bio").value = user.bio || "";
    if (user.profilePic) document.getElementById("profilePreviewImg").src = user.profilePic;
    if (user.coverPhoto) document.getElementById("coverPreviewImg").src = user.coverPhoto;
  }

  function saveSettings() {
    let user = getCurrentUser();
    if (!user) return;

    const newEmail = document.getElementById("newEmailPhone").value.trim();
    if (newEmail) user.email = newEmail;

    const newPass = document.getElementById("newPassword").value.trim();
    if (newPass) user.password = newPass;

    user.bio = document.getElementById("bio").value;

    const croppedProfile = document.getElementById("profilePreviewImg").dataset.cropped;
    const croppedCover = document.getElementById("coverPreviewImg").dataset.cropped;
    if (croppedProfile) user.profilePic = croppedProfile;
    if (croppedCover) user.coverPhoto = croppedCover;

    updateUserEverywhere(user);

    alert("âœ… Changes saved successfully!");
    window.location.href = "profile.html";
  }

  function clearSaved() {
    localStorage.removeItem("savedItems");
    alert("All saved items cleared!");
  }

  function deleteAccount() {
    if (!confirm("Are you sure you want to delete your account?")) return;
    let users = getUsers();
    const user = getCurrentUser();
    users = users.filter(u => u.email !== user.email);
    saveUsers(users);
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInUserId");
    window.location.href = "login_signup.html";
  }

  function logoutUser() {
    localStorage.removeItem("loggedInUserId");
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("redirectAfterLogin");
    localStorage.removeItem("openChatWith");
    localStorage.removeItem("selectedSellerId");

    alert("You have been logged out.");
    window.location.href = "login_signup.html";
  }

  window.onload = loadSettings;
</script>

</body>
</html>
