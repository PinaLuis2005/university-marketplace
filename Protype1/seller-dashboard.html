<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="seller-dashboard.css" />
  <style>
    .card-link { display:block; text-decoration:none; color:inherit; cursor:pointer; }
    .card-link:hover { filter: brightness(0.98); }
    .sold-overlay {
      position:absolute; top:10px; left:-40px; background:#ff4d4f; color:#fff;
      font-weight:700; padding:5px 50px; transform:rotate(-45deg); pointer-events:none;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .listing-card { position:relative; }
  </style>
</head>
<body>

<script>
  // Redirect if not logged in
  const authUser = JSON.parse(localStorage.getItem("userProfile")) || JSON.parse(localStorage.getItem("loggedInUser"));
  if (!authUser || !authUser.email) {
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "login_signup.html";
  } else {
    localStorage.setItem("userProfile", JSON.stringify(authUser));
    localStorage.setItem("loggedInUser", JSON.stringify(authUser));
    localStorage.setItem("loggedInUserId", authUser.email);
  }
</script>

<header class="top-bar">
  <div class="brand-group">
    <div class="brand-logo">U</div>
    <div class="logo-title">University Marketplace</div>
  </div>
  <nav class="nav-bubbles" aria-label="Main navigation">
    <a href="messages.html" class="nav-bubble">üí¨ Messages</a>
    <a href="index.html" class="nav-bubble">üõí Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble active">üìã My Listings</a>
    <a href="postitem.html" class="nav-bubble sell-button">‚ûï Sell Item</a>
  </nav>
  <div class="top-actions">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search listings" aria-label="Search listings">
      <button class="search-btn" aria-label="Search">üîç</button>
    </div>
    <div class="top-icons">
      <a href="notifications.html" class="icon-bubble" aria-label="Notifications">üîî</a>
      <a href="profile.html" class="icon-bubble" aria-label="Profile">üë§</a>
    </div>
  </div>
</header>

<main class="page-shell">
  <div class="dashboard-grid">
    <div class="dashboard-nav section-card">
      <div class="section-header">
        <h2 class="section-title">Seller Center</h2>
      </div>
      <nav class="dash-links">
        <a href="seller-dashboard.html" class="active">üìä Dashboard</a>
        <a href="payment-methods.html">üí≥ Payment Methods</a>
        <a href="settings.html">‚öôÔ∏è Settings</a>
        <a href="order-history.html">üì¶ Order History</a>
      </nav>
    </div>

    <div class="dashboard-content content-stack">
      <div class="card-grid">
        <div class="stat-card">
          <div class="label">Active Listings</div>
          <div class="value" id="activeCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Items Sold</div>
          <div class="value" id="soldCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Earnings</div>
          <div class="value" id="earnings">$0</div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">Active Listings</h2>
          <a href="postitem.html" class="btn-primary">Create listing</a>
        </div>
        <div class="listing-cards-grid" id="activeListings"></div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">Sold Items</h2>
          <span class="pill">History</span>
        </div>
        <div class="sold-list" id="soldListings"></div>
      </div>
    </div>
  </div>
</main>

<script>
  function getCurrentUserEmail() {
    const userProfile = JSON.parse(localStorage.getItem("userProfile"));
    if (userProfile && userProfile.email) return userProfile.email;
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user && user.email) return user.email;
    return localStorage.getItem("loggedInUserId");
  }

  function imgSrcFrom(item) {
    if (item.images && item.images.length) return item.images[0];
    return item.image || "https://via.placeholder.com/250x180?text=Item";
  }

  function setSelectedAndGo(id) {
    localStorage.setItem("selectedItemId", id);
  }

  function loadDashboard() {
    const email = getCurrentUserEmail();
    if (!email) return;

    const allItems = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const userItems = allItems.filter(i => i.sellerEmail === email);

    const activeItems = userItems.filter(i => !i.sold);
    const soldItems = userItems.filter(i => i.sold);

    // Metrics
    document.getElementById("activeCount").textContent = activeItems.length;
    document.getElementById("soldCount").textContent = soldItems.length;
    const totalEarnings = soldItems.reduce((sum, i) => sum + Number(i.price || 0), 0);
    document.getElementById("earnings").textContent = "$" + totalEarnings;

    const activeContainer = document.getElementById("activeListings");
    const soldContainer = document.getElementById("soldListings");

    // ACTIVE LISTINGS
    activeContainer.innerHTML = activeItems.length ? "" : "<p>No active listings yet.</p>";
    activeItems.forEach(item => {
      const card = document.createElement("div");
      card.classList.add("listing-card");
      card.innerHTML = `
        <a class="card-link" href="itemdetails.html" onclick="setSelectedAndGo('${item.id}')">
          ${item.sold ? '<div class="sold-overlay">SOLD</div>' : ""}
          <img src="${imgSrcFrom(item)}" alt="${item.title}">
          <div class="listing-info">
            <strong>${item.title}</strong>
            <p>$${item.price} ‚Ä¢ ${item.address || item.zipcode || "N/A"}</p>
            <p>Category: ${item.category} | Condition: ${item.condition}</p>
          </div>
        </a>
        <div class="listing-actions">
          <button onclick="markAsSold('${item.id}')">Mark Sold</button>
          <button onclick="deleteItem('${item.id}')">Delete</button>
        </div>
      `;
      activeContainer.appendChild(card);
    });

    // SOLD LISTINGS
    soldContainer.innerHTML = soldItems.length ? "" : "<p>No sold items yet.</p>";
    soldItems.forEach(item => {
      const soldCard = document.createElement("div");
      soldCard.classList.add("sold-item");
      soldCard.style.cursor = "pointer";
      soldCard.innerHTML = `
        <img src="${imgSrcFrom(item)}" alt="${item.title}">
        <div class="sold-info">
          <strong>${item.title}</strong>
          <p>Sold for $${item.price}</p>
          <p>Category: ${item.category} | Condition: ${item.condition}</p>
        </div>
      `;
      soldCard.addEventListener("click", () => {
        localStorage.setItem("selectedItemId", item.id);
        window.location.href = "itemdetails.html";
      });
      soldContainer.appendChild(soldCard);
    });
  }

  // Mark item as sold
  function markAsSold(itemId) {
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const updated = items.map(item => item.id == itemId ? { ...item, sold: true } : item);
    localStorage.setItem("marketplaceItems", JSON.stringify(updated));
    loadDashboard();
  }

  // Delete item
  function deleteItem(itemId) {
    if (!confirm("Are you sure you want to delete this item?")) return;
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const filtered = items.filter(item => item.id != itemId);
    localStorage.setItem("marketplaceItems", JSON.stringify(filtered));
    loadDashboard();
  }

  loadDashboard();
</script>

</body>
</html>
