<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <link rel="stylesheet" href="seller-dashboard.css" />
  <style>
    .card-link { display:block; text-decoration:none; color:inherit; cursor:pointer; }
    .card-link:hover { filter: brightness(0.98); }
    .sold-overlay {
      position:absolute; top:10px; left:-40px; background:#ff4d4f; color:#fff;
      font-weight:700; padding:5px 50px; transform:rotate(-45deg); pointer-events:none;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .listing-card { position:relative; }
  </style>
</head>
<body>

<script>
  // Redirect if not logged in
  if (!localStorage.getItem("loggedInUserId") && !localStorage.getItem("loggedInUser")) {
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "login_signup.html";
  }
</script>

<header class="top-bar">
  <div class="logo-title">ğŸ« University Marketplace</div>
  <nav class="nav-bubbles">
    <a href="messages.html" class="nav-bubble">ğŸ’¬ Messages</a>
    <a href="index.html" class="nav-bubble">ğŸ›’ Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble active">ğŸ“‹ My Listings</a>
    <a href="postitem.html" class="nav-bubble">â• Sell Item</a>
  </nav>
  <div class="top-right">
    <a href="notifications.html" class="icon-bubble">ğŸ”” Notifications</a>
    <a href="profile.html" class="icon-bubble">ğŸ‘¤ Profile</a>
  </div>
</header>

<div class="main-layout">
  <div class="sidebar">
    <a href="seller-dashboard.html" class="active">ğŸ“Š Dashboard</a>
    <a href="payment-methods.html">ğŸ’³ Payment Methods</a>
    <a href="settings.html">âš™ï¸ Settings</a>
    <a href="order-history.html">ğŸ“¦ Order History</a>
  </div>

  <div class="dashboard-content">
    <div class="card-row">
      <div class="metric-card">
        <div class="metric-title">Active Listings</div>
        <div class="metric-value" id="activeCount">0</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Items Sold</div>
        <div class="metric-value" id="soldCount">0</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Earnings</div>
        <div class="metric-value" id="earnings">$0</div>
      </div>
    </div>

    <div class="section">
      <h2>Active Listings</h2>
      <div class="listing-cards-grid" id="activeListings"></div>
    </div>

    <div class="section">
      <h2>Sold Items</h2>
      <div class="sold-list" id="soldListings"></div>
    </div>
  </div>
</div>

<script>
  function getCurrentUserEmail() {
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user && user.email) return user.email;
    return localStorage.getItem("loggedInUserId");
  }

  function imgSrcFrom(item) {
    if (item.images && item.images.length) return item.images[0];
    return item.image || "https://via.placeholder.com/250x180?text=Item";
  }

  function setSelectedAndGo(id) {
    localStorage.setItem("selectedItemId", id);
  }

  function loadDashboard() {
    const email = getCurrentUserEmail();
    if (!email) return;

    const allItems = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const userItems = allItems.filter(i => i.sellerEmail === email);

    const activeItems = userItems.filter(i => !i.sold);
    const soldItems = userItems.filter(i => i.sold);

    // Metrics
    document.getElementById("activeCount").textContent = activeItems.length;
    document.getElementById("soldCount").textContent = soldItems.length;
    const totalEarnings = soldItems.reduce((sum, i) => sum + Number(i.price || 0), 0);
    document.getElementById("earnings").textContent = "$" + totalEarnings;

    const activeContainer = document.getElementById("activeListings");
    const soldContainer = document.getElementById("soldListings");

    // ACTIVE LISTINGS
    activeContainer.innerHTML = activeItems.length ? "" : "<p>No active listings yet.</p>";
    activeItems.forEach(item => {
      const card = document.createElement("div");
      card.classList.add("listing-card");
      card.innerHTML = `
        <a class="card-link" href="itemdetails.html" onclick="setSelectedAndGo('${item.id}')">
          ${item.sold ? '<div class="sold-overlay">SOLD</div>' : ""}
          <img src="${imgSrcFrom(item)}" alt="${item.title}">
          <div class="listing-info">
            <strong>${item.title}</strong>
            <p>$${item.price} â€¢ ${item.address || item.zipcode || "N/A"}</p>
            <p>Category: ${item.category} | Condition: ${item.condition}</p>
          </div>
        </a>
        <div class="listing-actions">
          <button onclick="markAsSold('${item.id}')">Mark Sold</button>
          <button onclick="deleteItem('${item.id}')">Delete</button>
        </div>
      `;
      activeContainer.appendChild(card);
    });

    // SOLD LISTINGS
    soldContainer.innerHTML = soldItems.length ? "" : "<p>No sold items yet.</p>";
    soldItems.forEach(item => {
      const soldCard = document.createElement("div");
      soldCard.classList.add("sold-item");
      soldCard.style.cursor = "pointer";
      soldCard.innerHTML = `
        <img src="${imgSrcFrom(item)}" alt="${item.title}">
        <div class="sold-info">
          <strong>${item.title}</strong>
          <p>Sold for $${item.price}</p>
          <p>Category: ${item.category} | Condition: ${item.condition}</p>
        </div>
      `;
      soldCard.addEventListener("click", () => {
        localStorage.setItem("selectedItemId", item.id);
        window.location.href = "itemdetails.html";
      });
      soldContainer.appendChild(soldCard);
    });
  }

  // Mark item as sold
  function markAsSold(itemId) {
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const updated = items.map(item => item.id == itemId ? { ...item, sold: true } : item);
    localStorage.setItem("marketplaceItems", JSON.stringify(updated));
    loadDashboard();
  }

  // Delete item
  function deleteItem(itemId) {
    if (!confirm("Are you sure you want to delete this item?")) return;
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const filtered = items.filter(item => item.id != itemId);
    localStorage.setItem("marketplaceItems", JSON.stringify(filtered));
    loadDashboard();
  }

  loadDashboard();
</script>

</body>
</html>
