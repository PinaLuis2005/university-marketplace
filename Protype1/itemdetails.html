<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Item Details</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="itemdetails.css">
</head>
<body class="bg-neutral-50">

<header class="top-bar">
  <div class="brand-group">
    <div class="brand-logo">U</div>
    <div class="logo-title">University Marketplace</div>
  </div>

  <nav class="nav-bubbles" aria-label="Main navigation">
    <a href="messages.html" class="nav-bubble">üí¨ Messages</a>
    <a href="index.html" class="nav-bubble active">üõí Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble">üìã My Listings</a>
    <a href="postitem.html" class="nav-bubble sell-button">‚ûï Sell Item</a>
  </nav>

  <div class="top-actions">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search Marketplace..." aria-label="Search Marketplace">
      <button class="search-btn" aria-label="Search">üîç</button>
    </div>
    <div class="top-icons">
      <a href="notifications.html" class="icon-bubble" aria-label="Notifications">üîî</a>
      <a href="profile.html" class="icon-bubble" aria-label="Profile">üë§</a>
    </div>
  </div>
</header>

<main class="page-shell">
  <div class="content-stack">
    <header class="section-header">
      <div>
        <h1 class="section-title" id="itemTitle">Item Title</h1>
        <p class="muted" id="locationLabel">üìç Location</p>
      </div>
      <div class="price-pill" id="itemPrice">$0</div>
    </header>

    <section class="item-layout">
      <div class="gallery section-card">
        <div class="main-image listing-image-container" id="mainImage">Main Image</div>
        <div class="thumbnails" id="thumbnails"></div>
      </div>

      <div class="details section-card">
        <div class="detail-block">
          <div class="description-label">Description</div>
          <div class="description" id="itemDescription">Item description goes here.</div>
        </div>

        <div class="item-actions button-row">
          <button class="btn-primary" onclick="messageSeller()">üí¨ Message Seller</button>
          <button class="btn-secondary" onclick="addToFavorites()">‚ù§Ô∏è Save Item</button>
          <button class="btn-secondary" onclick="viewSellerProfile()">üë§ View Seller</button>
        </div>

        <div class="map-card">
          <div class="map-label">Location Preview</div>
          <div class="location-map" id="mapPreview">[Map preview goes here]</div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  function loadItemDetails() {
    const itemId = localStorage.getItem("selectedItemId");
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const item = items.find(i => String(i.id) === String(itemId));

    if (!item) {
      document.body.innerHTML = "<p>Item not found.</p>";
      return;
    }

    document.getElementById("itemTitle").textContent = item.title;
    document.getElementById("itemPrice").textContent = "$" + item.price;
    document.getElementById("itemDescription").textContent = item.description;
    document.getElementById("locationLabel").textContent =
      "üìç " + (item.address || item.zipcode || "N/A");

    const mainImage = document.getElementById("mainImage");
    const thumbnails = document.getElementById("thumbnails");

    let images = [];
    if (item.images && item.images.length > 0) {
      images = item.images;
    } else if (item.image) {
      images = [item.image];
    }

    if (images.length > 0) {
      mainImage.innerHTML = `<img src="${images[0]}" alt="${item.title}">`;
      thumbnails.innerHTML = images
        .map(
          img =>
            `<button class="thumbnail" type="button"><img src="${img}" alt="${item.title}"></button>`
        )
        .join("");

      document.querySelectorAll(".thumbnail img").forEach(imgEl => {
        imgEl.addEventListener("click", () => {
          mainImage.innerHTML = `<img src="${imgEl.src}" alt="${item.title}">`;
        });
      });
    } else {
      mainImage.textContent = "No Image";
    }

    const map = document.getElementById("mapPreview");
    if (item.map && item.map.includes("iframe")) {
      map.innerHTML = item.map;
    } else {
      map.textContent = "[No map provided]";
    }

    localStorage.setItem("sellerEmail", item.sellerEmail || item.seller);
  }

  function addToFavorites() {
    const itemId = localStorage.getItem("selectedItemId");
    let saved = JSON.parse(localStorage.getItem("savedItems")) || [];
    if (!saved.includes(itemId)) {
      saved.push(itemId);
      localStorage.setItem("savedItems", JSON.stringify(saved));
      alert("Item saved!");
    } else {
      alert("Already in saved items.");
    }
  }

  function messageSeller() {
    const seller = localStorage.getItem("sellerEmail");
    const currentUser = localStorage.getItem("loggedInUserId");

    if (!currentUser) {
      alert("Please log in to message the seller.");
      window.location.href = "login_signup.html";
      return;
    }

    if (seller === currentUser) {
      alert("You can‚Äôt message yourself!");
      return;
    }

    localStorage.setItem("openChatWith", seller);
    window.location.href = "messages.html";
  }

  function viewSellerProfile() {
    const sellerEmail = localStorage.getItem("sellerEmail");
    if (!sellerEmail) {
      alert("Seller profile not available.");
      return;
    }
    localStorage.setItem("selectedSellerId", sellerEmail);
    window.location.href = "profile.html";
  }

  loadItemDetails();
</script>

</body>
</html>
