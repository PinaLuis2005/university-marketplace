<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Item Details</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="itemdetails.css">
</head>
<body class="bg-neutral-50">

<header class="top-bar">
  <div class="brand-group">
    <div class="brand-logo">U</div>
    <div class="logo-title">University Marketplace</div>
  </div>

  <nav class="nav-bubbles" aria-label="Main navigation">
    <a href="messages.html" class="nav-bubble">üí¨ Messages</a>
    <a href="index.html" class="nav-bubble active">üõí Marketplace</a>
    <a href="seller-dashboard.html" class="nav-bubble">üìã My Listings</a>
    <a href="postitem.html" class="nav-bubble sell-button">‚ûï Sell Item</a>
  </nav>

  <div class="top-actions">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search Marketplace..." aria-label="Search Marketplace">
      <button class="search-btn" aria-label="Search">üîç</button>
    </div>
    <div class="top-icons">
      <a href="notifications.html" class="icon-bubble" aria-label="Notifications">üîî</a>
      <a href="profile.html" class="icon-bubble" aria-label="Profile">üë§</a>
    </div>
  </div>
</header>

<main class="page-shell">
  <div class="content-stack">
    <header class="section-header">
      <div>
        <h1 class="section-title" id="itemTitle">Item Title</h1>
        <p class="muted" id="locationLabel">üìç Location</p>
      </div>
      <div class="price-pill" id="itemPrice">$0</div>
    </header>

    <section class="item-layout">
      <div class="gallery section-card">
        <div class="main-image carousel-shell">
          <button class="carousel-arrow prev" type="button" aria-label="Previous image" id="prevImage">&#8592;</button>
          <div class="main-image-stage listing-image-container" id="mainImage">Main Image</div>
          <button class="carousel-arrow next" type="button" aria-label="Next image" id="nextImage">&#8594;</button>
        </div>
        <div class="thumbnails" id="thumbnails"></div>
      </div>

      <div class="details section-card">
        <div class="detail-header">
          <div>
            <p class="muted">Listing details</p>
            <h2 class="detail-title">Overview</h2>
          </div>
          <div class="meta-tags">
            <span class="pill soft">Secure checkout ready</span>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-label">Description</div>
          <div class="description" id="itemDescription">Item description goes here.</div>
        </div>

        <div class="info-panels">
          <div class="info-card">
            <div class="info-label">Location</div>
            <p class="info-text" id="locationDetail">üìç Location</p>
          </div>
          <div class="info-card">
            <div class="info-label">Delivery</div>
            <p class="info-text">Pickup or campus drop-off available</p>
          </div>
        </div>

        <div class="item-actions button-row">
          <button class="btn-primary" onclick="messageSeller()">üí¨ Message Seller</button>
          <button class="btn-secondary" onclick="addToFavorites()">‚ù§Ô∏è Save Item</button>
          <button class="btn-secondary" onclick="viewSellerProfile()">üë§ View Seller</button>
        </div>

        <div class="map-card">
          <div class="map-label">Location Preview</div>
          <div class="location-map" id="mapPreview">[Map preview goes here]</div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  const getUsers = () => JSON.parse(localStorage.getItem("users")) || [];
  const getUserByEmail = email => getUsers().find(u => u.email === email) || null;

  function loadItemDetails() {
    const itemId = localStorage.getItem("selectedItemId");
    const items = JSON.parse(localStorage.getItem("marketplaceItems")) || [];
    const item = items.find(i => String(i.id) === String(itemId));

    if (!item) {
      document.body.innerHTML = "<p>Item not found.</p>";
      return;
    }

    document.getElementById("itemTitle").textContent = item.title;
    document.getElementById("itemPrice").textContent = "$" + item.price;
    document.getElementById("itemDescription").textContent = item.description;
    document.getElementById("locationLabel").textContent =
      "üìç " + (item.address || item.zipcode || "N/A");
    const locationDetail = document.getElementById("locationDetail");
    if (locationDetail) {
      locationDetail.textContent = "üìç " + (item.address || item.zipcode || "N/A");
    }

    const mainImage = document.getElementById("mainImage");
    const thumbnails = document.getElementById("thumbnails");
    const prevBtn = document.getElementById("prevImage");
    const nextBtn = document.getElementById("nextImage");

    let images = [];
    if (item.images && item.images.length > 0) {
      images = item.images;
    } else if (item.image) {
      images = [item.image];
    }

    let currentIndex = 0;

    const toggleChrome = show => {
      [prevBtn, nextBtn].forEach(btn => {
        if (!btn) return;
        btn.classList.toggle("is-hidden", !show);
      });
      thumbnails.classList.toggle("is-hidden", !show);
    };

    const renderMainImage = () => {
      const currentSrc = images[currentIndex];
      mainImage.innerHTML = currentSrc
        ? `<img src="${currentSrc}" alt="${item.title}" class="fade-image">`
        : "No Image";

      const imgEl = mainImage.querySelector("img");
      if (imgEl) {
        requestAnimationFrame(() => imgEl.classList.add("visible"));
      }

      document.querySelectorAll(".thumbnail").forEach((thumb, index) => {
        thumb.classList.toggle("active", index === currentIndex);
      });
    };

    if (images.length > 0) {
      const hasCarousel = images.length > 1;

      if (hasCarousel) {
        thumbnails.innerHTML = images
          .map(
            (img, index) =>
              `<button class="thumbnail" type="button" aria-label="View image ${index + 1}"><img src="${img}" alt="${item.title}"></button>`
          )
          .join("");

        document.querySelectorAll(".thumbnail").forEach((btn, index) => {
          btn.addEventListener("click", () => {
            currentIndex = index;
            renderMainImage();
          });
        });

        const moveCarousel = direction => {
          currentIndex = (currentIndex + direction + images.length) % images.length;
          renderMainImage();
        };

        if (prevBtn && nextBtn) {
          prevBtn.addEventListener("click", () => moveCarousel(-1));
          nextBtn.addEventListener("click", () => moveCarousel(1));
        }

        toggleChrome(true);
      } else {
        toggleChrome(false);
      }

      renderMainImage();
    } else {
      mainImage.textContent = "No Image";
      thumbnails.innerHTML = "";
      toggleChrome(false);
    }

    const map = document.getElementById("mapPreview");
    if (item.map && item.map.includes("iframe")) {
      map.innerHTML = item.map;
    } else {
      map.textContent = "[No map provided]";
    }

    localStorage.setItem("sellerEmail", item.sellerEmail || item.seller);
  }

  function addToFavorites() {
    const itemId = localStorage.getItem("selectedItemId");
    let saved = JSON.parse(localStorage.getItem("savedItems")) || [];
    if (!saved.includes(itemId)) {
      saved.push(itemId);
      localStorage.setItem("savedItems", JSON.stringify(saved));
      alert("Item saved!");
    } else {
      alert("Already in saved items.");
    }
  }

  function messageSeller() {
    const seller = localStorage.getItem("sellerEmail");
    const sellerName = localStorage.getItem("sellerName") || seller;
    const currentUser =
      JSON.parse(localStorage.getItem("userProfile")) ||
      JSON.parse(localStorage.getItem("loggedInUser"));

    if (!currentUser || !currentUser.email) {
      alert("Please log in to message the seller.");
      localStorage.setItem("redirectAfterLogin", "itemdetails.html");
      window.location.href = "login_signup.html";
      return;
    }

    if (seller === currentUser.email) {
      alert("You can‚Äôt message yourself!");
      return;
    }

    localStorage.setItem("openChatWith", seller);
    window.location.href = "messages.html";
  }

  function viewSellerProfile() {
    const sellerEmail = localStorage.getItem("sellerEmail");
    if (!sellerEmail) {
      alert("Seller profile not available.");
      return;
    }
    localStorage.setItem("selectedSellerId", sellerEmail);
    window.location.href = "profile.html";
  }

  loadItemDetails();
</script>

</body>
</html>
